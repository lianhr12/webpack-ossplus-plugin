!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("path"),require("chalk"),require("lodash"),require("ali-oss"),require("cos-nodejs-sdk-v5"),require("qiniu"),require("buffer"),require("zlib")):"function"==typeof define&&define.amd?define(["exports","path","chalk","lodash","ali-oss","cos-nodejs-sdk-v5","qiniu","buffer","zlib"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).webpackossplusplugin={},e.path,e.chalk,e.lodash,e.AliOSS,e.COS,e.qiniu,e.buffer,e.zlib)}(this,(function(e,t,n,i,o,c,r,a,u){"use strict";function l(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=l(t),f=l(n),d=l(o),p=l(c),h=l(r),g=l(u);function S(e,t,n){if(n||2===arguments.length)for(var i,o=0,c=t.length;o<c;o++)!i&&o in t||(i||(i=Array.prototype.slice.call(t,0,o)),i[o]=t[o]);return e.concat(i||Array.prototype.slice.call(t))}var v,y={provider:{},retry:3,existCheck:!0,ossBaseDir:"auto_upload_ci",project:"",exclude:/.*\.html$/,include:/.*/,enableLog:!1,ignoreError:!1,removeMode:!0,gzip:!0},m=f.default.red,O=f.default.bold.green,k=f.default.yellow;!function(e){e[e.AliOSS=0]="AliOSS",e[e.QCloudOSS=1]="QCloudOSS",e[e.QiniuOSS=2]="QiniuOSS"}(v||(v={}));var b=function(){function e(e){this.config=y,this.client={},this.finalPrefix="",this.currentProvider={},this.config=i.mergeWith(i.cloneDeep(this.config),e||{},(function(e,t){return i.isPlainObject(e)&&i.isPlainObject(t)?i.merge(e,t):t}));var t=this.config,n=t.retry,o=t.provider,c=t.ossBaseDir,r=t.project;if(("number"!=typeof n||n<0)&&(this.config.retry=0),this.finalPrefix="".concat(c,"/").concat(r),this.debug("默认配置:",y),this.debug("项目配置:",e),this.debug("最终使用的配置:",this.config),void 0!==o.aliOSS){this.currentProvider=o.aliOSS,this.providerType=v.AliOSS;var a=o.aliOSS,u=a.accessKeyId,l=a.accessKeySecret,s=a.bucket,f=a.region;this.client=d.default({accessKeyId:u,accessKeySecret:l,bucket:s,region:f})}else if(void 0!==o.qcloudOS){this.currentProvider=o.qcloudOS,this.providerType=v.QCloudOSS;var g=o.qcloudOS,S=g.SecretId,m=g.SecretKey;this.client=new p.default({SecretId:S,SecretKey:m})}else if(void 0!==o.qiniuOSS){this.currentProvider=o.qiniuOSS,this.providerType=v.QiniuOSS;var O=o.qiniuOSS,k=O.accessKey,b=O.secretKey,P=(s=O.bucket,new h.default.auth.digest.Mac(k,b)),q={scope:s},F=new h.default.rs.PutPolicy(q).uploadToken(P),T=new h.default.conf.Config;T.zone=h.default.zone.Zone_z2;var w=new h.default.form_up.FormUploader(T),C=new h.default.form_up.PutExtra,j=new h.default.rs.BucketManager(P,T);this.client={qiniuToken:F,bucketManager:j,formUploader:w,putExtra:C}}}return e.prototype.apply=function(e){var t=this;if(e.hooks&&e.hooks.emit)e.hooks.emit.tapAsync("WebpackOSSPlusPlugin",(function(e,n){t.pluginEmitFn(e,n)}));else{if(void 0===e.plugin)return;e.plugin("emit",(function(e,n){t.pluginEmitFn(e,n)}))}},e.prototype.pickupAssetsFile=function(e){for(var t,n,o={},c=Object.keys(e.assets),r=0;r<c.length;r++){var a=c[r];(null===(t=this.config.exclude)||void 0===t?void 0:t.test(a))||(null===(n=this.config.include)||void 0===n?void 0:n.test(a))&&(o[a]=e.assets[a])}return i.map(o,(function(e,t){return{name:t,path:e.existsAt?e.existsAt:t,content:e.source()}}))},e.prototype.pluginEmitFn=function(e,t){var n=this,i=this.pickupAssetsFile(e);i?(q("".concat(O("\nOSS 上传开始......"))),this.batchUploadFiles(i,e).then((function(){q("".concat(O("OSS 上传完成\n"))),t()})).catch((function(i){q("".concat(m("OSS 上传出错"),"::: ").concat(m(i.code),"-").concat(m(i.name),": ").concat(m(i.message))),n.config.ignoreError||e.errors.push(i),t()}))):function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];console.warn.apply(console,S([f.default.bgMagenta("[webpack-ossplus-plugin]:")],e,!1))}("".concat(k("\n 没有找到符合条件的文件上传，请检测配置信息！")))},e.prototype.checkOSSFile=function(e,t,n,i,o){return this.providerType===v.AliOSS?this.aliCheckOSSFile(e,t,n,i,o):this.providerType===v.QCloudOSS?this.qcloudCheckOSSFile(e,t,n,i,o):this.providerType===v.QiniuOSS?this.qiniuCheckOSSFile(e,t,n,i,o):Promise.reject("检测OSS文件失败！")},e.prototype.aliCheckOSSFile=function(e,t,n,i,o){var c=this;return new Promise((function(r,a){c.client.list({prefix:o,"max-keys":50}).then((function(a){var u=(a.objects||[]).filter((function(e){return e.name===o}));if(!(u&&u.length>0))throw new Error("not exist & need upload");var l,s=(l=new Date(a.objects[0].lastModified),"".concat(l.getFullYear(),"-").concat(l.getMonth()+1,"-").concat(l.getDate()," ").concat(l.getHours(),":").concat(l.getMinutes()));q("".concat(O("已存在,免上传")," (上传于 ").concat(s,") ").concat(t,"/").concat(n.length,": ").concat(o)),c.config.removeMode&&delete i.assets[e.name],r(a)})).catch((function(u){c.uploadFile(e,t,n,i,o).then((function(e){r(e)})).catch((function(e){a(e)}))}))}))},e.prototype.qcloudCheckOSSFile=function(e,t,n,i,o){var c=this;return new Promise((function(r,a){c.client.headObject({Bucket:c.currentProvider.Bucket,Region:c.currentProvider.Region,key:o},(function(u,l){l?(q("".concat(O("已存在,免上传")," ").concat(t,"/").concat(n.length,": ").concat(o)),c.config.removeMode&&delete i.assets[e.name],r(l)):(404==u.statusCode?console.log("对象不存在"):403==u.statusCode&&console.log("没有该对象读权限"),c.qcloudUploadFile(e,t,n,i,o).then((function(e){r(e)})).catch((function(e){a(e)})))}))}))},e.prototype.qiniuCheckOSSFile=function(e,t,n,i,o){var c=this;return new Promise((function(r,a){c.client.bucketManager.stat(c.currentProvider.bucket,o,(function(u,l,s){u&&a(u),200==s.statusCode?(q("".concat(O("已存在,免上传")," ").concat(t,"/").concat(n.length,": ").concat(o)),c.config.removeMode&&delete i.assets[e.name],r(l)):c.qiniuUploadFile(e,t,n,i,o).then((function(e){r(e)})).catch((function(e){a(e)}))}))}))},e.prototype.batchUploadFiles=function(e,t){var n=this,o=1;return Promise.all(i.map(e,(function(i){var c;return i.$retryTime=0,c="/"===s.default.sep?s.default.join(n.finalPrefix,i.name):s.default.join(n.finalPrefix,i.name).split(s.default.sep).join("/"),n.config.existCheck?n.checkOSSFile(i,o++,e,t,c):n.uploadFile(i,o++,e,t,c)})))},e.prototype.uploadFile=function(e,t,n,i,o){return this.providerType===v.AliOSS?this.aliUploadFile(e,t,n,i,o):this.providerType===v.QCloudOSS?this.qcloudUploadFile(e,t,n,i,o):this.providerType===v.QiniuOSS?this.qiniuUploadFile(e,t,n,i,o):Promise.reject("没有找到上传SDK!")},e.prototype.aliUploadFile=function(e,t,n,i,o){var c=this;return new Promise((function(r,a){var u=n.length;P(e,c.config.gzip).then((function(n){var l=c.getOSSUploadOptions(),s=c;!function c(){e.$retryTime++,q("开始上传 ".concat(t,"/").concat(u,": ").concat(e.$retryTime>1?"第"+(e.$retryTime-1)+"次重试":""),o),s.client.put(o,n,l).then((function(n){q("上传成功 ".concat(t,"/").concat(u,": ").concat(o)),s.config.removeMode&&delete i.assets[e.name],r(n)})).catch((function(t){e.$retryTime<s.config.retry+1?c():a(t)}))}()})).catch((function(e){a(e)}))}))},e.prototype.qcloudUploadFile=function(e,t,n,i,o){var c=this;return new Promise((function(r,a){var u=n.length;P(e,c.config.gzip).then((function(n){var l=c;!function c(){e.$retryTime++,q("开始上传 ".concat(t,"/").concat(u,": ").concat(e.$retryTime>1?"第"+(e.$retryTime-1)+"次重试":""),o),l.client.putObject({Bucket:l.currentProvider.Bucket,Region:l.currentProvider.Region,Key:o,Body:n},(function(n,s){n?e.$retryTime<l.config.retry+1?c():a(n):(q("上传成功 ".concat(t,"/").concat(u,": ").concat(o)),l.config.removeMode&&delete i.assets[e.name],r(s))}))}()})).catch((function(e){a(e)}))}))},e.prototype.qiniuUploadFile=function(e,t,n,i,o){var c=this;return new Promise((function(r,a){var u=n.length;P(e,c.config.gzip).then((function(n){var l=c;!function c(){e.$retryTime++,q("开始上传 ".concat(t,"/").concat(u,": ").concat(e.$retryTime>1?"第"+(e.$retryTime-1)+"次重试":""),o),l.client.formUploader.put(l.client.qiniuToken,o,n,l.client.putExtra,(function(n,s,f){n&&(q("respErr: ".concat(n)),a(n)),200==f.statusCode?(q("上传成功 ".concat(t,"/").concat(u,": ").concat(o)),l.config.removeMode&&delete i.assets[e.name],r(s)):e.$retryTime<l.config.retry+1?c():a(s)}))}()})).catch((function(e){a(e)}))}))},e.prototype.getOSSUploadOptions=function(){var e=this.currentProvider.options;return this.config.gzip?e?(e.headers["Content-Encoding"]="gzip",e):{headers:{"Content-Encoding":"gzip"}}:e||void 0},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.config.enableLog&&q.apply(void 0,e)},e}();function P(e,t){return t?new Promise((function(t,n){g.default.gzip(a.Buffer.from(e.content),{},(function(e,i){e&&n(e),t(i)}))})):Promise.resolve(a.Buffer.from(e.content))}function q(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];console.log.apply(console,S([f.default.bgMagenta("[webpack-cdn-plugin]:")],e,!1))}e.WebpackOSSPlusPlugin=b,Object.defineProperty(e,"__esModule",{value:!0})}));
