!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("path"),require("chalk"),require("lodash"),require("ali-oss"),require("cos-nodejs-sdk-v5"),require("buffer"),require("zlib")):"function"==typeof define&&define.amd?define(["exports","path","chalk","lodash","ali-oss","cos-nodejs-sdk-v5","buffer","zlib"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).webpackossplusplugin={},e.path,e.chalk,e.lodash,e.AliOSS,e.COS,e.buffer,e.zlib)}(this,(function(e,t,n,o,i,c,r,a){"use strict";function l(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=l(t),u=l(n),f=l(i),d=l(c),p=l(a);function h(e,t,n){if(n||2===arguments.length)for(var o,i=0,c=t.length;i<c;i++)!o&&i in t||(o||(o=Array.prototype.slice.call(t,0,i)),o[i]=t[i]);return e.concat(o||Array.prototype.slice.call(t))}var g,S={provider:{},retry:3,existCheck:!0,ossBaseDir:"auto_upload_ci",project:"",exclude:/.*\.html$/,include:/.*/,enableLog:!1,ignoreError:!1,removeMode:!0,gzip:!0},v=u.default.red,y=u.default.bold.green,m=u.default.yellow;!function(e){e[e.AliOSS=0]="AliOSS",e[e.QCloudOSS=1]="QCloudOSS"}(g||(g={}));var O=function(){function e(e){this.config=S,this.client={},this.finalPrefix="",this.currentProvider={},this.config=o.mergeWith(o.cloneDeep(this.config),e||{},(function(e,t){return o.isPlainObject(e)&&o.isPlainObject(t)?o.merge(e,t):t}));var t=this.config,n=t.retry,i=t.provider,c=t.ossBaseDir,r=t.project;if(("number"!=typeof n||n<0)&&(this.config.retry=0),this.finalPrefix="".concat(c,"/").concat(r),this.debug("默认配置:",S),this.debug("项目配置:",e),this.debug("最终使用的配置:",this.config),void 0!==i.aliOSS){this.currentProvider=i.aliOSS,this.providerType=g.AliOSS;var a=i.aliOSS,l=a.accessKeyId,s=a.accessKeySecret,u=a.bucket,p=a.region;this.client=f.default({accessKeyId:l,accessKeySecret:s,bucket:u,region:p})}else if(void 0!==i.qcloudOS){this.currentProvider=i.qcloudOS,this.providerType=g.QCloudOSS;var h=i.qcloudOS,v=h.SecretId,y=h.SecretKey;this.client=new d.default({SecretId:v,SecretKey:y})}}return e.prototype.apply=function(e){var t=this;if(e.hooks&&e.hooks.emit)e.hooks.emit.tapAsync("WebpackOSSPlusPlugin",(function(e,n){t.pluginEmitFn(e,n)}));else{if(void 0===e.plugin)return;e.plugin("emit",(function(e,n){t.pluginEmitFn(e,n)}))}},e.prototype.pickupAssetsFile=function(e){for(var t,n,i={},c=Object.keys(e.assets),r=0;r<c.length;r++){var a=c[r];(null===(t=this.config.exclude)||void 0===t?void 0:t.test(a))||(null===(n=this.config.include)||void 0===n?void 0:n.test(a))&&(i[a]=e.assets[a])}return o.map(i,(function(e,t){return{name:t,path:e.existsAt?e.existsAt:t,content:e.source()}}))},e.prototype.pluginEmitFn=function(e,t){var n=this,o=this.pickupAssetsFile(e);o?(k("".concat(y("\nOSS 上传开始......"))),this.batchUploadFiles(o,e).then((function(){k("".concat(y("OSS 上传完成\n"))),t()})).catch((function(o){k("".concat(v("OSS 上传出错"),"::: ").concat(v(o.code),"-").concat(v(o.name),": ").concat(v(o.message))),n.config.ignoreError||e.errors.push(o),t()}))):function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];console.warn.apply(console,h([u.default.bgMagenta("[webpack-ossplus-plugin]:")],e,!1))}("".concat(m("\n 没有找到符合条件的文件上传，请检测配置信息！")))},e.prototype.checkOSSFile=function(e,t,n,o,i){return this.providerType===g.AliOSS?this.aliCheckOSSFile(e,t,n,o,i):this.providerType===g.QCloudOSS?this.qcloudCheckOSSFile(e,t,n,o,i):Promise.reject("检测OSS文件失败！")},e.prototype.aliCheckOSSFile=function(e,t,n,o,i){var c=this;return new Promise((function(r,a){c.client.list({prefix:i,"max-keys":50}).then((function(a){var l=(a.objects||[]).filter((function(e){return e.name===i}));if(!(l&&l.length>0))throw new Error("not exist & need upload");var s,u=(s=new Date(a.objects[0].lastModified),"".concat(s.getFullYear(),"-").concat(s.getMonth()+1,"-").concat(s.getDate()," ").concat(s.getHours(),":").concat(s.getMinutes()));k("".concat(y("已存在,免上传")," (上传于 ").concat(u,") ").concat(t,"/").concat(n.length,": ").concat(i)),c.config.removeMode&&delete o.assets[e.name],r(a)})).catch((function(l){c.uploadFile(e,t,n,o,i).then((function(e){r(e)})).catch((function(e){a(e)}))}))}))},e.prototype.qcloudCheckOSSFile=function(e,t,n,o,i){var c=this;return new Promise((function(r,a){c.client.headObject({Bucket:c.currentProvider.Bucket,Region:c.currentProvider.Region,key:i},(function(l,s){s?(k("".concat(y("已存在,免上传")," ").concat(t,"/").concat(n.length,": ").concat(i)),c.config.removeMode&&delete o.assets[e.name],r(s)):(404==l.statusCode?console.log("对象不存在"):403==l.statusCode&&console.log("没有该对象读权限"),c.qcloudUploadFile(e,t,n,o,i).then((function(e){r(e)})).catch((function(e){a(e)})))}))}))},e.prototype.batchUploadFiles=function(e,t){var n=this,i=1;return Promise.all(o.map(e,(function(o){var c;return o.$retryTime=0,c="/"===s.default.sep?s.default.join(n.finalPrefix,o.name):s.default.join(n.finalPrefix,o.name).split(s.default.sep).join("/"),n.config.existCheck?n.checkOSSFile(o,i++,e,t,c):n.uploadFile(o,i++,e,t,c)})))},e.prototype.uploadFile=function(e,t,n,o,i){return this.providerType===g.AliOSS?this.aliUploadFile(e,t,n,o,i):this.providerType===g.QCloudOSS?this.qcloudUploadFile(e,t,n,o,i):Promise.reject("没有找到上传SDK!")},e.prototype.aliUploadFile=function(e,t,n,o,i){var c=this;return new Promise((function(r,a){var l=n.length;b(e,c.config.gzip).then((function(n){var s=c.getOSSUploadOptions(),u=c;!function c(){e.$retryTime++,k("开始上传 ".concat(t,"/").concat(l,": ").concat(e.$retryTime>1?"第"+(e.$retryTime-1)+"次重试":""),i),u.client.put(i,n,s).then((function(n){k("上传成功 ".concat(t,"/").concat(l,": ").concat(i)),u.config.removeMode&&delete o.assets[e.name],r(n)})).catch((function(t){e.$retryTime<u.config.retry+1?c():a(t)}))}()})).catch((function(e){a(e)}))}))},e.prototype.qcloudUploadFile=function(e,t,n,o,i){var c=this;return new Promise((function(r,a){var l=n.length;b(e,c.config.gzip).then((function(n){var s=c;!function c(){e.$retryTime++,k("开始上传 ".concat(t,"/").concat(l,": ").concat(e.$retryTime>1?"第"+(e.$retryTime-1)+"次重试":""),i),s.client.putObject({Bucket:s.currentProvider.Bucket,Region:s.currentProvider.Region,Key:i,Body:n},(function(n,u){n?e.$retryTime<s.config.retry+1?c():a(n):(k("上传成功 ".concat(t,"/").concat(l,": ").concat(i)),s.config.removeMode&&delete o.assets[e.name],r(u))}))}()})).catch((function(e){a(e)}))}))},e.prototype.getOSSUploadOptions=function(){var e=this.currentProvider.options;return this.config.gzip?e?(e.headers["Content-Encoding"]="gzip",e):{headers:{"Content-Encoding":"gzip"}}:e||void 0},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.config.enableLog&&k.apply(void 0,e)},e}();function b(e,t){return t?new Promise((function(t,n){p.default.gzip(r.Buffer.from(e.content),{},(function(e,o){e&&n(e),t(o)}))})):Promise.resolve(r.Buffer.from(e.content))}function k(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];console.log.apply(console,h([u.default.bgMagenta("[webpack-cdn-plugin]:")],e,!1))}e.WebpackOSSPlusPlugin=O,Object.defineProperty(e,"__esModule",{value:!0})}));
